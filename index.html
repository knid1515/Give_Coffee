<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>เลี้ยงกาแฟ • Demo</title>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      box-sizing: border-box;
    }
    @keyframes floatMoney {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-4px); }
    }
    @keyframes spin {
      to { transform: rotate(360deg) }
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .spin { animation: spin 1s linear infinite; }
    .panel-content { animation: fadeIn 0.3s ease-out; }
    .list-item-new { animation: fadeIn 0.4s ease-out; }
    
    .metal-ring {
      background: linear-gradient(135deg, rgba(255,255,255,0.25), rgba(255,255,255,0.02));
    }
    .glass {
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-amber-900 via-orange-800 to-rose-800 font-[Prompt] antialiased text-slate-800">
  <div class="min-h-screen w-full flex items-center justify-center p-4">
    <div class="relative w-full max-w-[420px]">
      <div class="relative">
        <div class="metal-ring absolute inset-0 rounded-[2.2rem] shadow-[0_20px_50px_rgba(0,0,0,0.5)]"></div>
        <div id="phone"
             class="relative rounded-[2rem] overflow-hidden border border-white/10 bg-gradient-to-b from-amber-50 to-orange-50 shadow-2xl">
          <div class="absolute top-2 left-1/2 -translate-x-1/2 z-20">
            <div class="w-40 h-6 bg-black/90 rounded-3xl"></div>
          </div>

          <div class="relative pt-10 pb-4 px-5 bg-gradient-to-br from-amber-600 via-amber-500 to-orange-500 text-white">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 rounded-xl bg-white/15 grid place-items-center shadow-inner"
                   style="animation: floatMoney 3s ease-in-out infinite;">
                <svg viewBox="0 0 24 24" class="w-6 h-6 text-emerald-200" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6h-.75m0 0v-.75A.75.75 0 013 4.5h.75m0 0h.75A.75.75 0 015.25 6v.75m0 0v-.75A.75.75 0 015.25 4.5h-.75m0 0a.75.75 0 01.75.75v.75m0 0v.75A.75.75 0 015.25 8.25h-.75m0 0a.75.75 0 01-.75-.75v-.75m0 0A.75.75 0 013 6.75h.75m0 0h.75a.75.75 0 01.75.75v.75m0 0v-.75A.75.75 0 015.25 9h-.75m0 0a.75.75 0 01-.75-.75V7.5m0 0A.75.75 0 013 6.75h.75M4.5 12v.75a.75.75 0 01-.75.75h-.75a.75.75 0 01-.75-.75V12m0 0v-.75a.75.75 0 01.75-.75h.75a.75.75 0 01.75.75V12m0 0v.75a.75.75 0 01-.75.75h-.75a.75.75 0 01-.75-.75V12m9-3.75a.75.75 0 01.75.75v.75a.75.75 0 01-.75.75h-.75a.75.75 0 01-.75-.75v-.75a.75.75 0 01.75-.75h.75z" />
                </svg>
              </div>
              <div class="flex-1">
                <div class="flex items-center gap-2">
                  <h1 class="text-xl font-semibold leading-tight">เลี้ยงกาแฟเรา</h1>
                  <span class="text-[10px] px-2 py-0.5 rounded-full bg-white/20">Demo</span>
                </div>
                <p class="text-white/90 text-sm">ขอบคุณที่สนับสนุน ☕️</p>
              </div>
            </div>

            <div class="mt-4 p-1 bg-white/15 rounded-xl glass">
              <div class="grid grid-cols-2 gap-1">
                <button id="tabForm" class="tab-btn w-full text-center text-sm font-medium px-3 py-2 rounded-lg transition-all">แบบฟอร์ม</button>
                <button id="tabDashboard" class="tab-btn w-full text-center text-sm font-medium px-3 py-2 rounded-lg transition-all">แดชบอร์ด</button>
              </div>
            </div>
          </div>

          <div class="relative px-5 pb-24 pt-4">
            <section id="panelForm" class="panel-content space-y-4">
              <div class="p-4 rounded-2xl bg-amber-100/80 border border-amber-200 text-amber-900">
                <div class="flex items-start gap-3">
                  <div class="w-8 h-8 rounded-lg bg-amber-200 grid place-items-center text-amber-800">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path d="M10.499 2.25c.343 0 .68.055 1.006.162C13.43 3.1 15 4.83 15 6.75V8.25a.75.75 0 001.5 0V6.75c0-2.42-1.93-4.44-4.363-4.494A4.502 4.502 0 007.5 6.75v1.5a.75.75 0 001.5 0V6.75c0-1.92 1.57-3.65 3.499-4.338V2.25z" /><path d="M15.75 8.25v-.03a.75.75 0 10-1.5 0v.03a.75.75 0 101.5 0z" /><path fill-rule="evenodd" d="M20.25 12.375a.75.75 0 01.75.75v6a.75.75 0 01-.75.75H3.75a.75.75 0 01-.75-.75v-6a.75.75 0 01.75-.75h16.5zm-16.5 1.5a.75.75 0 01.75.75v4.5a.75.75 0 01-.75.75H3.75a.75.75 0 01-.75-.75v-4.5a.75.75 0 01.75-.75h.001z" clip-rule="evenodd" /></svg>
                  </div>
                  <div class="text-sm">
                    <p class="font-medium">เลี้ยงกาแฟ 1 แก้ว (เดโม)</p>
                    <p class="text-amber-800/90">อัปโหลดสลิปธนาคาร แล้วกดส่ง ระบบจะแสดงแจ้งเตือนและบันทึกลงแดชบอร์ด</p>
                  </div>
                </div>
              </div>

              <div class="p-4 rounded-2xl bg-white border border-slate-200 flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-emerald-100 text-emerald-700 grid place-items-center font-semibold text-lg">฿</div>
                <div class="flex-1 min-w-0">
                  <p class="text-xs text-slate-500">PromptPay</p>
                  <p id="ppDisplay" class="text-sm font-semibold text-slate-800 truncate">0812345678</p>
                </div>
                <button id="copyPPBtn" type="button" class="px-3 py-2 rounded-xl bg-emerald-600 text-white text-sm hover:bg-emerald-700 transition-colors duration-200 w-[80px] text-center">คัดลอก</button>
              </div>

              <form id="donateForm" class="space-y-4">
                <div>
                  <label for="name" class="block text-sm font-medium text-slate-700 mb-1">ชื่อของคุณ</label>
                  <input id="name" name="name" type="text" autocomplete="off" required class="w-full rounded-xl border border-slate-200 bg-white px-4 py-3 outline-none focus:ring-4 focus:ring-amber-200 focus:border-amber-400 placeholder:text-slate-400 transition" placeholder="เช่น กานต์" />
                  <p id="errName" class="hidden mt-1 text-xs text-rose-600" aria-live="polite">กรุณากรอกชื่อ</p>
                </div>

                <div>
                  <label for="phone" class="block text-sm font-medium text-slate-700 mb-1">เบอร์โทรศัพท์</label>
                  <input id="phone" name="phone" type="tel" inputmode="numeric" pattern="[0-9\s\-+]*" required class="w-full rounded-xl border border-slate-200 bg-white px-4 py-3 outline-none focus:ring-4 focus:ring-amber-200 focus:border-amber-400 placeholder:text-slate-400 transition" placeholder="เช่น 0812345678" />
                  <p id="errPhone" class="hidden mt-1 text-xs text-rose-600" aria-live="polite">กรุณากรอกเบอร์ที่ถูกต้อง (อย่างน้อย 9 หลัก)</p>
                </div>

                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-1">อัปโหลดสลิปธนาคาร</label>
                  <div id="dropzone" class="group relative rounded-2xl border-2 border-dashed border-amber-300 bg-amber-50 hover:bg-amber-100/80 transition p-4 cursor-pointer">
                    <div class="flex items-center gap-3">
                      <div class="w-12 h-12 rounded-xl bg-amber-200/80 grid place-items-center text-amber-800">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m.75 12l3 3m0 0l3-3m-3 3v-6m-1.5-9H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>
                      </div>
                      <div class="flex-1">
                        <p class="text-sm font-medium text-amber-900">ลากไฟล์มาวาง หรือกดเพื่อเลือก</p>
                        <p class="text-xs text-amber-800/80">รองรับรูปภาพ ขนาดไม่เกิน 3MB</p>
                      </div>
                    </div>
                    <input id="slip" name="slip" type="file" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" required />
                  </div>
                  <p id="errSlip" class="hidden mt-2 text-xs text-rose-600" aria-live="polite">กรุณาอัปโหลดสลิปรูปภาพ (ไม่เกิน 3MB)</p>

                  <div id="previewWrap" class="hidden mt-3">
                    <div class="flex items-center justify-between mb-2">
                      <span class="text-xs font-medium text-slate-600">ตัวอย่างสลิป</span>
                      <button id="clearSlip" type="button" class="text-xs text-rose-600 hover:underline">ลบไฟล์</button>
                    </div>
                    <div id="slipPreview" class="w-full h-40 rounded-xl border border-slate-200 bg-slate-100 bg-center bg-cover"></div>
                  </div>
                </div>

                <div class="pt-1">
                  <button id="submitBtn" type="submit" class="w-full rounded-xl bg-emerald-600 text-white font-semibold py-3.5 shadow-md shadow-emerald-800/20 hover:bg-emerald-700 active:scale-[.99] transition">
                    ส่งสลิปเพื่อเลี้ยงกาแฟ
                  </button>
                  <p class="mt-2 text-[11px] text-slate-500 text-center">
                    หมายเหตุ: เดโมนี้ไม่เชื่อมต่อการชำระเงินจริง
                  </p>
                </div>
              </form>
            </section>

            <section id="panelDashboard" class="panel-content hidden space-y-4">
              <div class="p-3 rounded-2xl bg-white border border-slate-200 flex items-center justify-between">
                <div class="text-sm text-slate-600">เครื่องมือทดสอบ</div>
                <button id="seedSamples" type="button" class="px-3 py-2 rounded-xl bg-amber-600 text-white text-xs font-semibold hover:bg-amber-700 active:scale-[.99] transition">
                  เพิ่มตัวอย่าง
                </button>
              </div>

              <div class="grid grid-cols-2 gap-3">
                <div class="p-4 rounded-2xl bg-emerald-50 border border-emerald-200">
                  <p class="text-xs text-emerald-700">จำนวนแก้ว</p>
                  <p id="sumCount" class="text-2xl font-semibold text-emerald-900">0</p>
                </div>
                <div class="p-4 rounded-2xl bg-sky-50 border border-sky-200">
                  <p class="text-xs text-sky-700">ล่าสุด</p>
                  <p id="sumLast" class="text-sm font-medium text-sky-900">—</p>
                </div>
              </div>

              <div class="rounded-2xl border border-slate-200 bg-white overflow-hidden">
                <div class="px-4 py-3 bg-slate-50 border-b border-slate-200">
                  <p class="text-sm font-semibold text-slate-700">รายการล่าสุด</p>
                </div>
                <ul id="listWrap" class="divide-y divide-slate-100 max-h-[360px] overflow-y-auto">
                  </ul>
                <div id="emptyState" class="p-8 text-center text-slate-500 text-sm hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-10 h-10 mx-auto text-slate-400 mb-2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 7.5l.415-.207a.75.75 0 011.085.67V10.5m0 0h6m-6 0a.75.75 0 001.085.67l.415-.207A.75.75 0 0010.5 10.5v-3m5.25 4.5h-6m6 0a.75.75 0 01-1.085.67l-.415-.207a.75.75 0 01-.67-1.085V10.5m0 0a.75.75 0 01.75-.75h3.375a.75.75 0 01.75.75v3.375a.75.75 0 01-.75.75h-3.375a.75.75 0 01-.75-.75v-3.375z" /></svg>
                    <p class="font-medium">ยังไม่มีรายการ</p>
                    <p class="text-xs text-slate-400 mt-1">ลองอัปโหลดสลิปจากแท็บ "แบบฟอร์ม"</p>
                </div>
              </div>
            </section>
          </div>

          <div class="pointer-events-none absolute bottom-0 inset-x-0 h-16 bg-gradient-to-t from-black/5 to-transparent"></div>

          <div id="loading" class="hidden absolute inset-0 bg-black/30 glass grid place-items-center z-30 transition-opacity duration-300">
            <div class="bg-white rounded-2xl p-5 shadow-xl w-[84%] max-w-sm text-center">
              <div class="mx-auto w-10 h-10 rounded-full border-2 border-amber-300 border-t-amber-600 spin mb-3"></div>
              <p class="text-sm font-medium text-slate-700">กำลังประมวลผล...</p>
              <p class="text-xs text-slate-500">โปรดรอสักครู่</p>
            </div>
          </div>

          <div id="modal" class="hidden absolute inset-0 bg-black/40 glass z-40 transition-opacity duration-300">
            <div class="w-full h-full flex items-end sm:items-center justify-center p-4">
              <div id="modalContent" class="w-full max-w-sm bg-white rounded-2xl shadow-2xl overflow-hidden">
                <div id="modalHeader" class="px-5 py-4 border-b">
                  <p id="modalTitle" class="font-semibold"></p>
                </div>
                <div id="modalBody" class="px-5 py-4 text-slate-700">
                  <p id="modalMessage" class="text-sm"></p>
                  <div id="modalImage" class="hidden mt-3 w-full h-72 rounded-xl bg-slate-100 bg-center bg-contain bg-no-repeat"></div>
                </div>
                <div class="px-5 py-4 border-t border-slate-100 flex items-center justify-end gap-2">
                  <button id="modalSecondary" class="hidden px-4 py-2 rounded-xl bg-slate-100 hover:bg-slate-200 text-slate-700 text-sm transition">ยกเลิก</button>
                  <button id="modalPrimary" class="px-4 py-2 rounded-xl text-white text-sm transition">ปิด</button>
                </div>
              </div>
            </div>
          </div>
        </div> </div>
    </div>
  </div>

  <script>
    // ---------- State & Config ----------
    const LS_KEY = 'coffeeDonations';
    const PROMPTPAY_ID = '0812345678';
    let donations = [];
    let slipDataURL = '';
    const $$ = (s, p=document) => p.querySelector(s);
    const TABS = {
      form: { id: 'form', btn: $$('#tabForm'), panel: $$('#panelForm') },
      dashboard: { id: 'dashboard', btn: $$('#tabDashboard'), panel: $$('#panelDashboard') },
    };

    // ---------- Elements ----------
    const donateForm = $$('#donateForm');
    const nameEl = $$('#name');
    const phoneEl = $$('#phone');
    const ppDisplay = $$('#ppDisplay');
    const copyPPBtn = $$('#copyPPBtn');
    const dropzone = $$('#dropzone');
    const slipInput = $$('#slip');
    const previewWrap = $$('#previewWrap');
    const slipPreview = $$('#slipPreview');
    const clearSlipBtn = $$('#clearSlip');
    const loading = $$('#loading');
    const sumCount = $$('#sumCount');
    const sumLast = $$('#sumLast');
    const listWrap = $$('#listWrap');
    const emptyState = $$('#emptyState');
    const errName = $$('#errName');
    const errPhone = $$('#errPhone');
    const errSlip = $$('#errSlip');
    // Modal Elements
    const modal = $$('#modal');
    const modalContent = $$('#modalContent');
    const modalHeader = $$('#modalHeader');
    const modalTitle = $$('#modalTitle');
    const modalMessage = $$('#modalMessage');
    const modalImage = $$('#modalImage');
    const modalPrimary = $$('#modalPrimary');
    const modalSecondary = $$('#modalSecondary');

    // ---------- Utils ----------
    const thTime = (d) => new Intl.DateTimeFormat('th-TH', { dateStyle: 'medium', timeStyle: 'short' }).format(d);
    const id = () => Date.now().toString(36) + Math.random().toString(36).slice(2, 7);
    const maskPhone = (v) => {
      const d = (v || '').replace(/\D/g, '');
      if (d.length <= 3) return d;
      if (d.length <= 7) return `${d.slice(0,3)}-xxx`;
      return `${d.slice(0,3)}-xxx-${d.slice(-4)}`;
    }
    const showLoading = (v) => loading.classList.toggle('hidden', !v);

    const setActiveTab = (tabId) => {
      const activeClasses = 'bg-white text-amber-700 shadow';
      const inactiveClasses = 'text-white/90 hover:text-white bg-transparent shadow-none';
      Object.values(TABS).forEach(tab => {
        const isActive = tab.id === tabId;
        tab.panel.classList.toggle('hidden', !isActive);
        if (isActive) tab.panel.classList.add('panel-content');
        tab.btn.className = `tab-btn w-full text-center text-sm font-medium px-3 py-2 rounded-lg transition-all ${isActive ? activeClasses : inactiveClasses}`;
      });
      if (tabId === 'dashboard') renderDashboard();
    }

    const readLS = () => { try { return JSON.parse(localStorage.getItem(LS_KEY) || '[]'); } catch { return []; } }
    const writeLS = () => localStorage.setItem(LS_KEY, JSON.stringify(donations));

    // ---------- Modal Logic ----------
    let modalResolve = null;
    const openModal = ({ title, message, tone='success', primaryText='ปิด', secondaryText='', image='' } = {}) => {
      modalTitle.textContent = title || '';
      modalMessage.textContent = message || '';
      modalImage.classList.toggle('hidden', !image);
      modalImage.style.backgroundImage = image ? `url('${image}')` : '';
      const TONES = {
        success: { header: "bg-emerald-50 border-emerald-100", title: "text-emerald-800", btn: "bg-emerald-600 hover:bg-emerald-700" },
        danger: { header: "bg-rose-50 border-rose-100", title: "text-rose-800", btn: "bg-rose-600 hover:bg-rose-700" },
        info: { header: "bg-sky-50 border-sky-100", title: "text-sky-800", btn: "bg-sky-600 hover:bg-sky-700" },
      };
      const c = TONES[tone] || TONES.success;
      modalHeader.className = `px-5 py-4 border-b ${c.header}`;
      modalTitle.className = `font-semibold ${c.title}`;
      modalPrimary.className = `px-4 py-2 rounded-xl text-white text-sm transition ${c.btn}`;
      modalPrimary.textContent = primaryText || 'ปิด';
      modalSecondary.classList.toggle('hidden', !secondaryText);
      if (secondaryText) modalSecondary.textContent = secondaryText;
      
      modal.classList.remove('hidden');
      modalContent.style.animation = 'fadeIn 0.2s ease-out';
      return new Promise((resolve) => { modalResolve = resolve; });
    };
    const closeModal = (result=null) => {
      modal.classList.add('hidden');
      if (modalResolve) { modalResolve(result); modalResolve = null; }
    };
    modalPrimary.addEventListener('click', () => closeModal(true));
    modalSecondary.addEventListener('click', () => closeModal(false));
    modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(null); });

    // ---------- Dropzone ----------
    dropzone.addEventListener('dragover', (e) => { e.preventDefault(); dropzone.classList.add('bg-amber-100'); });
    dropzone.addEventListener('dragleave', () => dropzone.classList.remove('bg-amber-100'));
    dropzone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropzone.classList.remove('bg-amber-100');
      if (e.dataTransfer.files && e.dataTransfer.files[0]) {
        slipInput.files = e.dataTransfer.files;
        handleSlipChange();
      }
    });
    slipInput.addEventListener('change', handleSlipChange);
    clearSlipBtn.addEventListener('click', () => {
      slipInput.value = '';
      slipDataURL = '';
      previewWrap.classList.add('hidden');
      slipPreview.style.backgroundImage = '';
      validateSlip();
    });

    function handleSlipChange() {
      const f = slipInput.files && slipInput.files[0];
      if (!f) return;
      if (!validateSlipFile(f)) return;
      
      const reader = new FileReader();
      reader.onload = () => {
        slipDataURL = reader.result;
        previewWrap.classList.remove('hidden');
        slipPreview.style.backgroundImage = `url('${slipDataURL}')`;
      };
      reader.readAsDataURL(f);
    }

    // ---------- Validation ----------
    const validateName = () => { const ok = !!(nameEl && nameEl.value.trim()); errName.classList.toggle('hidden', ok); return ok; }
    const validatePhone = () => { const ok = !!(phoneEl && phoneEl.value.replace(/\D/g, '').length >= 9); errPhone.classList.toggle('hidden', ok); return ok; }
    const validateSlip = () => { const ok = !!slipDataURL; errSlip.classList.toggle('hidden', ok); return ok; }
    const validateSlipFile = (file) => {
      errSlip.classList.add('hidden');
      if (!file.type.startsWith('image/')) {
        errSlip.textContent = 'ไฟล์ต้องเป็นรูปภาพเท่านั้น';
        errSlip.classList.remove('hidden');
        return false;
      }
      if (file.size > 3 * 1024 * 1024) {
        errSlip.textContent = 'ขนาดไฟล์เกิน 3MB';
        errSlip.classList.remove('hidden');
        return false;
      }
      return true;
    };
    const validateForm = () => [validateName(), validatePhone(), validateSlip()].every(Boolean);

    // ---------- Render ----------
    function renderDashboard() {
      const has = donations.length > 0;
      sumCount.textContent = String(donations.length);
      sumLast.textContent = has ? thTime(new Date(donations[0].createdAt)) : '—';
      emptyState.classList.toggle('hidden', has);
      listWrap.innerHTML = '';
      donations.forEach((d, index) => {
        const li = createListItem(d);
        if (index === 0 && listWrap.dataset.isNew) {
            li.classList.add('list-item-new');
            delete listWrap.dataset.isNew;
        }
        listWrap.appendChild(li);
      });
    }

    function createListItem(d) {
        const li = document.createElement('li');
        li.className = "px-4 py-3 bg-white";
        li.innerHTML = `
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-amber-100 text-amber-800 grid place-items-center font-semibold shrink-0">
              ${escapeHtml(d.name.trim().charAt(0).toUpperCase())}
            </div>
            <div class="flex-1 min-w-0">
              <p class="text-sm font-medium text-slate-800 truncate">${escapeHtml(d.name)}</p>
              <p class="text-xs text-slate-500 truncate">${escapeHtml(maskPhone(d.phone))}</p>
              <p class="text-[11px] text-slate-400">${thTime(new Date(d.createdAt))}</p>
            </div>
            <div class="flex items-center gap-2 shrink-0">
              <button data-id="${d.id}" data-action="view" class="px-3 py-1.5 rounded-lg bg-sky-50 text-sky-700 hover:bg-sky-100 text-xs font-medium transition">ดูสลิป</button>
              <button data-id="${d.id}" data-action="delete" class="px-3 py-1.5 rounded-lg bg-rose-50 text-rose-700 hover:bg-rose-100 text-xs font-medium transition">ลบ</button>
            </div>
          </div>
        `;
        return li;
    }

    function escapeHtml(s='') {
      return s.replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
    }

    // ---------- Handlers ----------
    if (copyPPBtn) {
        copyPPBtn.addEventListener('click', async () => {
          try {
            await navigator.clipboard.writeText(PROMPTPAY_ID);
            const originalText = copyPPBtn.textContent;
            copyPPBtn.textContent = 'คัดลอกแล้ว!';
            copyPPBtn.disabled = true;
            copyPPBtn.classList.replace('bg-emerald-600', 'bg-green-500');
            setTimeout(() => {
              copyPPBtn.textContent = originalText;
              copyPPBtn.disabled = false;
              copyPPBtn.classList.replace('bg-green-500', 'bg-emerald-600');
            }, 2000);
          } catch (err) {
            openModal({ title: 'คัดลอกไม่สำเร็จ', message: 'อุปกรณ์ของคุณไม่อนุญาต โปรดคัดลอกเอง', tone: 'danger' });
          }
        });
    }
    
    if(nameEl) nameEl.addEventListener('blur', validateName);
    if(phoneEl) phoneEl.addEventListener('blur', validatePhone);

    if (donateForm) {
        donateForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          if (!validateForm()) return;
          showLoading(true);
          await new Promise(r => setTimeout(r, 1200 + Math.random() * 500));
          
          const item = {
            id: id(),
            name: nameEl.value.trim(),
            phone: phoneEl.value.trim(),
            slip: slipDataURL,
            createdAt: new Date().toISOString()
          };
          donations.unshift(item);
          writeLS();
          showLoading(false);

          donateForm.reset();
          clearSlipBtn.click();
          [errName, errPhone, errSlip].forEach(el => el.classList.add('hidden'));

          await openModal({
            title: 'สำเร็จ!',
            message: 'ขอบคุณที่เลี้ยงกาแฟ รายการถูกบันทึกในแดชบอร์ดแล้ว',
            tone: 'success',
            primaryText: 'ดูแดชบอร์ด'
          });
          listWrap.dataset.isNew = true;
          setActiveTab('dashboard');
        });
    }

    listWrap.addEventListener('click', async (e) => {
      const btn = e.target.closest('button[data-action]');
      if (!btn) return;
      const id = btn.getAttribute('data-id');
      const action = btn.getAttribute('data-action');
      const idx = donations.findIndex(d => d.id === id);
      if (idx === -1) return;

      if (action === 'view') {
        openModal({ title: 'ดูสลิป', message: 'ตัวอย่างสลิปธนาคาร', tone: 'info', image: donations[idx].slip });
      } else if (action === 'delete') {
        const confirm = await openModal({ title: 'ยืนยันการลบ', message: 'คุณต้องการลบรายการนี้หรือไม่?', tone: 'danger', primaryText: 'ลบ', secondaryText: 'ยกเลิก' });
        if (confirm) {
          donations.splice(idx, 1);
          writeLS();
          renderDashboard();
          openModal({ title: 'ลบแล้ว', message: 'รายการถูกลบออกจากแดชบอร์ด', tone: 'success' });
        }
      }
    });

    $$('#seedSamples')?.addEventListener('click', async () => {
      const samples = [{ name: 'นัท', phone: '0891112222' }, { name: 'ฝน', phone: '0815556666' }, { name: 'เจ',  phone: '0827778888' }];
      const tinyImg = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAukB9y5e2/8AAAAASUVORK5CYII=';
      samples.forEach(s => { donations.unshift({ id: id(), name: s.name, phone: s.phone, slip: tinyImg, createdAt: new Date(Date.now() - Math.random() * 86400000).toISOString() }); });
      donations.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
      writeLS();
      listWrap.dataset.isNew = true;
      renderDashboard();
      openModal({ title: 'เพิ่มตัวอย่างแล้ว', message: 'เราใส่รายการตัวอย่างลงในแดชบอร์ดให้ทดสอบแล้ว', tone: 'success' });
    });

    TABS.form.btn.addEventListener('click', () => setActiveTab('form'));
    TABS.dashboard.btn.addEventListener('click', () => setActiveTab('dashboard'));

    // ---------- Init ----------
    function init() {
      donations = readLS();
      if(ppDisplay) ppDisplay.textContent = PROMPTPAY_ID;
      setActiveTab('form');
    }
    
    // Run init after the DOM is fully loaded
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
